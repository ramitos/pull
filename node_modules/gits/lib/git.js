var spawn = require('child_process').spawn;
var path = require('path');

// figure out if we are running from the cloud
var prog = 'e:\\sitesroot\\0\\__runtime\\bin\\git.exe';
if (!path.existsSync(prog)) {
  prog = 'git';
}

// calls 'git' with the specified args
// callback = function(err, stdout, stderr).
module.exports = function (dir, args, d, callback) {
    if (typeof (args) == "string") args = [args];
    if (!dir) throw new Error('dir is required');
    var command = prog + ' ' + args.join(' ');
		/* debug */ d('' + command + '(cwd:' + dir + ')');
    //console.info('git --', command, '(cwd:', dir, ')');
    var git = spawn(prog, args, { cwd: dir });
    var stdout = '';
    var stderr = '';
    git.stdout.on('data', function (data) { stdout += data.toString(); });
    git.stderr.on('data', function (data) { stderr += data.toString(); });
    git.on('exit', function (code) {
        var err = null;
				(code !== '') ? d('exit code: ' + code) : null;
				(stderr !== '') ? d('stderr: ' + stderr, 'error') : null;
				(stdout !== '') ? d('stdout: ' + stdout) : null;
        if (code != 0) err = { code: code, msg: stderr };
        if (callback) callback(err, stdout, stderr);
    });
};
